---

- name: Build HDP3.3
  gather_facts: false
  hosts: all
  become: yes
  tasks:
    - name: Create hadoop user
      user:
        name: hadoop
        generate_ssh_key: yes
        ssh_key_bits: 4096
        ssh_key_file: .ssh/id_rsa

    - name: Install Java 11 and Jenkins
      yum:
        name: "{{packages}}"
        state: latest
      vars:
        packages:
        - java-11-openjdk-devel

- hosts: master
  become: yes
  tasks:
    - name: Create authorized_keys file
      shell:
        cmd: cp /home/hadoop/.ssh/id_rsa.pub /home/hadoop/.ssh/authorized_keys
    
    - name: Push keys to nodes
      shell:
        cmd: scp -r .ssh {{ item }}:/home/hadoop/
        chdir: /home/hadoop
      loop:
        - node1
        - node2

    - name: Create /opt/hadoop on master
      file:
        path: /opt/hadoop
        state: directory
        mode: '755'
        owner: hadoop
        group: hadoop

    - name: Get Hadoop distribution checksum
      get_url:
        url: https://downloads.apache.org/hadoop/common/hadoop-3.3.0/hadoop-3.3.0.tar.gz.sha512
        dest: /var/tmp/

    - name: Store checksum
      slurp:
        src: /var/tmp/hadoop-3.3.0.tar.gz.sha512
      register: hdp_checksum64

    - name: Get Hadoop distribution
      get_url: 
        url: https://downloads.apache.org/hadoop/common/hadoop-3.3.0/hadoop-3.3.0.tar.gz
        dest: /var/tmp/
        checksum: "sha512:{{ hdp_checksum.split( )[3] }}"
      vars:
        hdp_checksum: '{{ hdp_checksum64.content | b64decode }}'

    - name: Unpack hadoop distribution
      unarchive:
        src: /var/tmp/hadoop-3.3.0.tar.gz
        dest: /opt
        owner: hadoop
        group: hadoop
        remote_src: yes

    - name: Create Hadoop Version Symlink
      file:
        src: /opt/hadoop-3.3.0
        dest: /opt/hadoop
        owner: hadoop
        group: hadoop
        state: link


- hosts: all
  become: yes
  tasks:

    - name: Set permissions on hadoop ssh keys
      file:
        path: /home/hadoop/.ssh
        owner: hadoop
        group: hadoop
        recurse: yes
        mode: '0600'
    
    - name: Set permissions on hadoop ssh dir
      file:
        path: /home/hadoop/.ssh
        owner: hadoop
        group: hadoop
        mode: '0700'

    - name: Setup hadoop PATH
      lineinfile:
        path: /home/hadoop/.bash_profile
        regexp: '^PATH='
        line: PATH=/opt/hadoop/bin:/opt/hadoop/sbin:$PATH

    - name: Setup HADOOP_HOME
      lineinfile:
        path: /home/hadoop/.bash_profile
        regexp: '^HADOOP_HOME='
        line: HADOOP_HOME=/opt/hadoop

    - name: Setup Export
      lineinfile:
        path: /home/hadoop/.bash_profile
        regexp: '^export'
        line: export PATH HADOOP_HOME

